<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn Importer - PF-ADS</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    .step { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    button { background: #0077b5; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
    button:disabled { background: #ccc; }
    .debug { background: #f5f5f5; padding: 15px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 12px; }
  </style>
</head>
<body>
  <h1>LinkedIn Importer - Debug Version</h1>
  
  <div class="step">
    <h3>1. Получить Authorization Code</h3>
    <button onclick="getAuthCode()">Get Auth Code</button>
    <div>
      <label>Authorization Code:</label>
      <input type="text" id="authCode" style="width: 300px; padding: 5px;" placeholder="Paste code here">
    </div>
  </div>

  <div class="step">
    <h3>2. Получить Access Token</h3>
    <button onclick="getAccessToken()" id="tokenBtn">Get Access Token</button>
    <div id="tokenResult" class="debug"></div>
  </div>

  <div class="step">
    <h3>3. Получить Посты</h3>
    <button onclick="getPosts()" id="postsBtn" disabled>Get Posts</button>
    <div id="postsResult" class="debug"></div>
  </div>

  <script>
    let accessToken = '';

    function getAuthCode() {
      const clientId = '77c7i4jjqp5e8g';
      const redirectUri = 'https://www.pf-ads.com/linkedin/callback';
      const scope = 'r_liteprofile r_member_social w_member_social';
      const state = Math.random().toString(36).substring(7);
      
      const authUrl = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&state=${state}`;
      
      window.open(authUrl, '_blank');
      
      alert('После авторизации скопируйте code из URL и вставьте в поле выше.\nURL будет выглядеть так: https://www.pf-ads.com/linkedin/callback?code=AQT...');
    }

    async function getAccessToken() {
      const code = document.getElementById('authCode').value.trim();
      if (!code) {
        alert('Введите authorization code');
        return;
      }

      const btn = document.getElementById('tokenBtn');
      btn.disabled = true;
      btn.textContent = 'Getting token...';

      try {
        const response = await fetch('/functions/linkedin-posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'get_token',
            code: code
          })
        });

        const result = await response.json();
        document.getElementById('tokenResult').innerHTML = JSON.stringify(result, null, 2);
        
        if (result.success) {
          accessToken = result.access_token;
          document.getElementById('postsBtn').disabled = false;
        }
      } catch (error) {
        document.getElementById('tokenResult').innerHTML = 'Error: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Get Access Token';
      }
    }

    async function getPosts() {
      if (!accessToken) {
        alert('No access token');
        return;
      }

      const btn = document.getElementById('postsBtn');
      btn.disabled = true;
      btn.textContent = 'Loading posts...';

      try {
        const response = await fetch('/functions/linkedin-posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'get_posts',
            access_token: accessToken
          })
        });

        const result = await response.json();
        document.getElementById('postsResult').innerHTML = JSON.stringify(result, null, 2);
      } catch (error) {
        document.getElementById('postsResult').innerHTML = 'Error: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Get Posts';
      }
    }
  </script>
</body>
</html>
