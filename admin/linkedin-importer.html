<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LinkedIn Importer - PF-ADS</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      max-width: 1000px; 
      margin: 0 auto; 
      padding: 20px; 
      background: #f5f6f8;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .step {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
    }
    .step-number {
      background: #667eea;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background: #5a67d8; }
    button:disabled { background: #a0aec0; cursor: not-allowed; }
    .post-card {
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
    }
    .post-card.selected { border-color: #667eea; background: #edf2f7; }
    .loading { color: #667eea; }
    .success { color: #38a169; }
    .error { color: #e53e3e; }
    textarea { 
      width: 100%; 
      height: 200px; 
      padding: 10px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      font-family: monospace; 
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì• –ò–º–ø–æ—Ä—Ç –ø–æ—Å—Ç–æ–≤ –∏–∑ LinkedIn</h1>
    
    <!-- –®–∞–≥ 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
    <div class="step">
      <h3><span class="step-number">1</span> –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ LinkedIn</h3>
      <p>–ü–æ–ª—É—á–∏—Ç–µ access token –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–∏–º –ø–æ—Å—Ç–∞–º:</p>
      <button onclick="openLinkedInAuth()">üîó –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ LinkedIn</button>
      <div style="margin-top: 15px;">
        <label><strong>Access Token:</strong></label>
        <input type="text" id="accessToken" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à LinkedIn access token" 
               style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 5px;">
      </div>
    </div>

    <!-- –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ -->
    <div class="step">
      <h3><span class="step-number">2</span> –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤</h3>
      <button onclick="loadLinkedInPosts()" id="loadBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã –∏–∑ LinkedIn</button>
      <div id="postsList" style="margin-top: 15px;"></div>
    </div>

    <!-- –®–∞–≥ 3: –ü—É–±–ª–∏–∫–∞—Ü–∏—è -->
    <div class="step">
      <h3><span class="step-number">3</span> –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–∞ —Å–∞–π—Ç–µ</h3>
      <button onclick="publishSelectedPosts()" id="publishBtn" disabled>üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã</button>
      <div id="publishResult" style="margin-top: 15px;"></div>
    </div>
  </div>

  <script>
    let loadedPosts = [];
    let selectedPosts = [];

    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ LinkedIn
    function openLinkedInAuth() {
      const clientId = 'YOUR_LINKEDIN_CLIENT_ID';
      const redirectUri = 'https://www.pf-ads.com/linkedin/callback';
      const scope = 'r_liteprofile r_member_social w_member_social';
      const state = Math.random().toString(36).substring(2);
      
      const authUrl = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}&state=${state}`;
      
      window.open(authUrl, '_blank');
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤ –∏–∑ LinkedIn
    async function loadLinkedInPosts() {
      const accessToken = document.getElementById('accessToken').value.trim();
      if (!accessToken) {
        alert('–í–≤–µ–¥–∏—Ç–µ access token');
        return;
      }

      const loadBtn = document.getElementById('loadBtn');
      loadBtn.disabled = true;
      loadBtn.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

      try {
        const response = await fetch('/linkedin-posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'get_posts',
            access_token: accessToken 
          })
        });

        const result = await response.json();
        
        if (result.success) {
          loadedPosts = result.posts;
          displayPosts(loadedPosts);
          document.getElementById('publishBtn').disabled = false;
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤: ' + error.message);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã –∏–∑ LinkedIn';
      }
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ—Å—Ç–æ–≤
    function displayPosts(posts) {
      const postsList = document.getElementById('postsList');
      postsList.innerHTML = '<h4>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã:</h4>';
      
      posts.forEach((post, index) => {
        const postElement = document.createElement('div');
        postElement.className = 'post-card';
        postElement.innerHTML = `
          <label style="display: block; cursor: pointer;">
            <input type="checkbox" onchange="togglePostSelection(${index})" style="margin-right: 10px;">
            <strong>${post.title}</strong>
            <small style="color: #666; display: block;">${new Date(post.date).toLocaleDateString()}</small>
            <div style="margin-top: 10px; max-height: 100px; overflow: hidden;">${post.content.substring(0, 200)}...</div>
          </label>
        `;
        postsList.appendChild(postElement);
      });
    }

    // –í—ã–±–æ—Ä/–æ—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –ø–æ—Å—Ç–∞
    function togglePostSelection(index) {
      const postIndex = selectedPosts.indexOf(index);
      if (postIndex > -1) {
        selectedPosts.splice(postIndex, 1);
      } else {
        selectedPosts.push(index);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
      const postCards = document.querySelectorAll('.post-card');
      postCards.forEach((card, i) => {
        if (selectedPosts.includes(i)) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      });
    }

    // –ü—É–±–ª–∏–∫–∞—Ü–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤
    async function publishSelectedPosts() {
      if (selectedPosts.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç—ã –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
        return;
      }

      const publishBtn = document.getElementById('publishBtn');
      const resultDiv = document.getElementById('publishResult');
      
      publishBtn.disabled = true;
      publishBtn.textContent = '‚è≥ –ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
      resultDiv.innerHTML = '<div class="loading">üöÄ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤...</div>';

      let successCount = 0;
      let errorCount = 0;

      for (const postIndex of selectedPosts) {
        const post = loadedPosts[postIndex];
        
        try {
          const filename = `${post.date.split('T')[0]}-linkedin-${post.id}.md`;
          const postContent = `---
title: "${post.title.replace(/"/g, '\\"')}"
date: ${post.date}
linkedin_url: "${post.linkedin_url}"
source: "linkedin"
---
${post.content}
`;

          const response = await fetch('/linkedin-posts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'publish_post',
              post_data: {
                filename: filename,
                title: post.title,
                content: postContent
              }
            })
          });

          const result = await response.json();
          
          if (result.success) {
            successCount++;
            resultDiv.innerHTML += `<div class="success">‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω: ${post.title}</div>`;
          } else {
            errorCount++;
            resultDiv.innerHTML += `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${post.title} - ${result.error}</div>`;
          }
        } catch (error) {
          errorCount++;
          resultDiv.innerHTML += `<div class="error">‚ùå –û—à–∏–±–∫–∞: ${post.title} - ${error.message}</div>`;
        }
      }

      resultDiv.innerHTML += `<div class="success"><strong>‚úÖ –ì–æ—Ç–æ–≤–æ! –£—Å–ø–µ—à–Ω–æ: ${successCount}, –û—à–∏–±–æ–∫: ${errorCount}</strong></div>`;
      publishBtn.disabled = false;
      publishBtn.textContent = 'üöÄ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã';
    }
  </script>
</body>
</html>
